name: Update Repository Metadata

on:
  workflow_call:
    inputs:
      repo-name:
        required: false
        type: string
        description: 'Nome do repositório (formato: owner/repo). Se não fornecido, usa o repositório atual'
      config-file:
        required: false
        type: string
        default: '.repo.yml'
        description: 'Caminho do arquivo de configuração'
    secrets:
      token:
        required: false
        description: 'GitHub Token com permissão de repo. Se não fornecido, usa GITHUB_TOKEN padrão'

jobs:
  update-metadata:
    runs-on: ubuntu-latest
    permissions:
      contents: read

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Read repository config
        id: read-config
        run: |
          if [ ! -f "${{ inputs.config-file }}" ]; then
            echo "Arquivo ${{ inputs.config-file }} não encontrado"
            exit 1
          fi
          
          # Instala yq se não estiver disponível
          if ! command -v yq &> /dev/null; then
            sudo wget -qO /usr/local/bin/yq https://github.com/mikefarah/yq/releases/latest/download/yq_linux_amd64
            sudo chmod +x /usr/local/bin/yq
          fi
          
          # Lê os valores do arquivo YAML
          DESCRIPTION=$(yq eval '.description // ""' ${{ inputs.config-file }})
          HOMEPAGE=$(yq eval '.homepage // ""' ${{ inputs.config-file }})
          
          echo "description=$DESCRIPTION" >> $GITHUB_OUTPUT
          echo "homepage=$HOMEPAGE" >> $GITHUB_OUTPUT
          
          echo "Descrição lida: $DESCRIPTION"
          echo "Homepage lida: $HOMEPAGE"

      - name: Update repository metadata
        env:
          GITHUB_TOKEN: ${{ secrets.token || secrets.GITHUB_TOKEN }}
          REPO_NAME: ${{ inputs.repo-name || github.repository }}
          DESCRIPTION: ${{ steps.read-config.outputs.description }}
          HOMEPAGE: ${{ steps.read-config.outputs.homepage }}
        run: |
          echo "Atualizando metadados do repositório: $REPO_NAME"
          
          # Monta o payload JSON
          PAYLOAD=$(jq -n \
            --arg desc "$DESCRIPTION" \
            --arg home "$HOMEPAGE" \
            '{description: $desc, homepage: $home}')
          
          # Faz a requisição PATCH
          RESPONSE=$(curl -s -w "\n%{http_code}" -X PATCH \
            -H "Accept: application/vnd.github+json" \
            -H "Authorization: Bearer $GITHUB_TOKEN" \
            -H "X-GitHub-Api-Version: 2022-11-28" \
            "https://api.github.com/repos/$REPO_NAME" \
            -d "$PAYLOAD")
          
          # Extrai o status code
          HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
          BODY=$(echo "$RESPONSE" | sed '$d')
          
          if [ "$HTTP_CODE" -eq 200 ]; then
            echo "✅ Metadados atualizados com sucesso!"
            echo "Descrição: $DESCRIPTION"
            echo "Homepage: $HOMEPAGE"
          else
            echo "❌ Erro ao atualizar metadados. Status code: $HTTP_CODE"
            echo "Resposta: $BODY"
            exit 1
          fi