name: Update Repository Metadata

on:
  workflow_call:
    secrets:
      token:
        required: false
        description: 'GitHub Token com permiss√£o de repo. Se n√£o fornecido, usa GITHUB_TOKEN padr√£o'

jobs:
  update-metadata:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install yq
        run: |
          sudo wget -qO /usr/local/bin/yq https://github.com/mikefarah/yq/releases/latest/download/yq_linux_amd64
          sudo chmod +x /usr/local/bin/yq

      - name: Update repository metadata
        env:
          GITHUB_TOKEN: ${{ secrets.token || secrets.GITHUB_TOKEN }}
          CONFIG_FILE: '.repo.yml'
        run: |
          set -e

          # Verifica se arquivo existe
          if [ ! -f "$CONFIG_FILE" ]; then
            echo "‚ùå Arquivo $CONFIG_FILE n√£o encontrado"
            exit 1
          fi

          # L√™ valores do YAML diretamente
          description=$(yq '.repository.description' "$CONFIG_FILE")
          homepage=$(yq '.repository.website' "$CONFIG_FILE")

          echo "üìù Atualizando reposit√≥rio: ${{ github.repository }}"
          echo "Descri√ß√£o: $description"
          echo "Homepage: $homepage"

          # Atualiza descri√ß√£o e homepage
          curl -f -X PATCH \
            -H "Accept: application/vnd.github+json" \
            -H "Authorization: Bearer $GITHUB_TOKEN" \
            -H "X-GitHub-Api-Version: 2022-11-28" \
            "https://api.github.com/repos/${{ github.repository }}" \
            -d "$(jq -n --arg d "$description" --arg h "$homepage" '{description: $d, homepage: $h}')"

          echo "‚úÖ Metadados atualizados com sucesso!"

          # Atualiza topics
          topics=$(yq '.repository.topics // []' "$CONFIG_FILE" -o=json)
          
          if [ "$topics" != "[]" ] && [ "$topics" != "null" ]; then
            echo ""
            echo "üè∑Ô∏è  Atualizando topics..."
            
            curl -f -X PUT \
              -H "Accept: application/vnd.github+json" \
              -H "Authorization: Bearer $GITHUB_TOKEN" \
              -H "X-GitHub-Api-Version: 2022-11-28" \
              "https://api.github.com/repos/${{ github.repository }}/topics" \
              -d "$(jq -n --argjson t "$topics" '{names: $t}')"
            
            echo "‚úÖ Topics atualizados com sucesso!"
          fi